<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senera - AI Outfit Generator</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .navbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px 0; border-bottom: 1px solid #eee; }
        .navbar .nav-links a { text-decoration: none; color: #007bff; font-weight: bold; margin-right: 20px; }
        .navbar .user-info { color: #666; font-size: 0.9em; }
        .navbar .logout-btn { background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em; }
        .upload-form { border: 2px dashed #ccc; padding: 30px; text-align: center; margin-bottom: 20px; }
        .result { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
        .loading { display: none; color: #666; font-style: italic; padding: 15px; background: #fff3cd; border-radius: 5px; margin: 10px 0; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input[type="file"], input[type="text"] { margin: 10px; padding: 8px; width: 300px; }
        .outfit-image { max-width: 100%; border-radius: 8px; margin-top: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .auth-required { display: none; text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; }
        .auth-required h2 { color: #007bff; }
        .auth-required a { color: #007bff; text-decoration: none; padding: 10px 20px; background: white; border: 2px solid #007bff; border-radius: 5px; margin: 0 10px; }
        .auth-required a:hover { background: #007bff; color: white; }
    </style>
</head>
<body>
    <!-- Authentication Required Screen -->
    <div id="authRequired" class="auth-required">
        <h2>ðŸ‘— Welcome to Senera</h2>
        <p>Please sign in to access your personalized wardrobe and outfit generator.</p>
        <div style="margin-top: 30px;">
            <a href="login.html">Sign In</a>
            <a href="register.html">Create Account</a>
        </div>
    </div>

    <!-- Main App Content (hidden until authenticated) -->
    <div id="mainContent" style="display: none;">
        <div class="navbar">
            <div class="nav-links">
                <a href="index.html">Outfit Generator</a>
                <a href="wardrobe.html">Wardrobe</a>
            </div>
            <div class="user-info">
                Welcome, <span id="userName">User</span>!
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <h1>ðŸ‘— Senera - AI Outfit Generator</h1>

        <div class="upload-form">
            <h3>Upload Clothing Item</h3>
            <input type="file" id="clothingImage" accept="image/*">
            <br>
            <button onclick="uploadClothing()">Add to Wardrobe</button>
        </div>

        <div class="upload-form">
            <h3>Generate Outfit</h3>
            <input type="text" id="outfitPrompt" placeholder="e.g., Casual outfit for warm weather">
            <br>
            <button onclick="generateCompleteOutfit()">Generate Outfit</button>
        </div>

        <div id="loading" class="loading"></div>
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        let currentUser = null;

        // Check authentication on page load
        async function checkAuth() {
            try {
                const response = await fetch('/current-user');
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    document.getElementById('userName').textContent = currentUser.display_name;
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('authRequired').style.display = 'none';
                } else {
                    document.getElementById('mainContent').style.display = 'none';
                    document.getElementById('authRequired').style.display = 'block';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('authRequired').style.display = 'block';
            }
        }

        // Logout function
        async function logout() {
            try {
                await fetch('/logout', { method: 'POST' });
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Upload clothing function
        async function uploadClothing() {
            const fileInput = document.getElementById('clothingImage');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an image first!');
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            const loading = document.getElementById('loading');
            const result = document.getElementById('result');

            loading.style.display = 'block';
            loading.textContent = 'Uploading and processing your clothing item...';
            result.style.display = 'none';

            try {
                const response = await fetch('/upload-clothing', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = `<p style="color: green;"><strong>Success!</strong> ${data.message}</p>`;
                    result.style.display = 'block';
                    fileInput.value = '';
                } else {
                    result.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>`;
                    result.style.display = 'block';
                }
            } catch (error) {
                result.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${error.message}</p>`;
                result.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // Generate complete outfit function
        async function generateCompleteOutfit() {
            const promptInput = document.getElementById('outfitPrompt');
            const prompt = promptInput.value.trim();
            
            if (!prompt) {
                alert('Please enter an outfit description!');
                return;
            }

            const loading = document.getElementById('loading');
            const result = document.getElementById('result');

            loading.style.display = 'block';
            loading.textContent = 'Analyzing your wardrobe and generating outfit...';
            result.style.display = 'none';

            try {
                const response = await fetch('/generate-complete-outfit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                const data = await response.json();
                
                if (response.ok) {
                    let resultHTML = `
                        <h3>Generated Outfit</h3>
                        <p><strong>Prompt:</strong> ${prompt}</p>
                        <p><strong>Status:</strong> ${data.message}</p>
                    `;
                    
                    if (data.collage_url) {
                        resultHTML += `
                            <h4>Selected Items:</h4>
                            <img src="${data.collage_url}" alt="Selected clothing items" style="max-width: 100%; border-radius: 5px; margin: 10px 0;">
                        `;
                    }
                    
                    if (data.outfit_image_url) {
                        resultHTML += `
                            <h4>Your AI-Generated Outfit:</h4>
                            <img src="${data.outfit_image_url}" alt="Generated outfit" class="outfit-image">
                        `;
                    }
                    
                    result.innerHTML = resultHTML;
                    result.style.display = 'block';
                } else {
                    result.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>`;
                    result.style.display = 'block';
                }
            } catch (error) {
                result.innerHTML = `<p style="color: red;"><strong>Error:</strong> ${error.message}</p>`;
                result.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // Initialize on page load
        checkAuth();
    </script>
</body>
</html>