<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senera - My Wardrobe</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .navbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px 0; border-bottom: 1px solid #eee; }
        .navbar .nav-links a { text-decoration: none; color: #007bff; font-weight: bold; margin-right: 20px; }
        .navbar .user-info { color: #666; font-size: 0.9em; }
        .navbar .logout-btn { background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em; }
        .wardrobe-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .wardrobe-item { border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .wardrobe-item img { max-width: 100%; height: 150px; object-fit: contain; border-radius: 5px; }
        .item-tags { margin-top: 10px; font-size: 0.9em; color: #666; }
        .tag { background: #e9ecef; padding: 2px 6px; border-radius: 3px; margin: 2px; display: inline-block; font-size: 0.8em; }
        .loading { display: none; text-align: center; padding: 20px; color: #666; font-style: italic; }
        .empty-wardrobe { text-align: center; padding: 40px; color: #666; }
        .cleanup-btn { background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
        .cleanup-btn:hover { background: #c82333; }
        .auth-required { display: none; text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; }
        .auth-required h2 { color: #007bff; }
        .auth-required a { color: #007bff; text-decoration: none; padding: 10px 20px; background: white; border: 2px solid #007bff; border-radius: 5px; margin: 0 10px; }
        .auth-required a:hover { background: #007bff; color: white; }
    </style>
</head>
<body>
    <!-- Authentication Required Screen -->
    <div id="authRequired" class="auth-required">
        <h2>ðŸ‘— Welcome to Senera</h2>
        <p>Please sign in to access your personalized wardrobe.</p>
        <div style="margin-top: 30px;">
            <a href="login.html">Sign In</a>
            <a href="register.html">Create Account</a>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <div class="navbar">
            <div class="nav-links">
                <a href="index.html">Outfit Generator</a>
                <a href="wardrobe.html">Wardrobe</a>
            </div>
            <div class="user-info">
                Welcome, <span id="userName">User</span>!
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <h1>ðŸ‘— My Wardrobe</h1>
        
        <button class="cleanup-btn" onclick="cleanupUnknownItems()">Clean Up Unknown Items</button>
        
        <div id="loading" class="loading">Loading your wardrobe...</div>
        
        <div id="emptyWardrobe" class="empty-wardrobe" style="display: none;">
            <h3>Your wardrobe is empty</h3>
            <p>Go to the <a href="index.html">Outfit Generator</a> to start uploading your clothing items!</p>
        </div>
        
        <div id="wardrobeGrid" class="wardrobe-grid"></div>
    </div>

    <script>
        let currentUser = null;

        // Check authentication on page load
        async function checkAuth() {
            try {
                const response = await fetch('/current-user');
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    document.getElementById('userName').textContent = currentUser.display_name;
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('authRequired').style.display = 'none';
                    loadWardrobe();
                } else {
                    document.getElementById('mainContent').style.display = 'none';
                    document.getElementById('authRequired').style.display = 'block';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('authRequired').style.display = 'block';
            }
        }

        // Logout function
        async function logout() {
            try {
                await fetch('/logout', { method: 'POST' });
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Load wardrobe items
        async function loadWardrobe() {
            const loading = document.getElementById('loading');
            const wardrobeGrid = document.getElementById('wardrobeGrid');
            const emptyWardrobe = document.getElementById('emptyWardrobe');

            loading.style.display = 'block';
            wardrobeGrid.innerHTML = '';
            emptyWardrobe.style.display = 'none';

            try {
                const response = await fetch('/wardrobe-items');
                
                if (response.ok) {
                    const items = await response.json();
                    
                    if (items.length === 0) {
                        emptyWardrobe.style.display = 'block';
                    } else {
                        displayWardrobeItems(items);
                    }
                } else {
                    const errorData = await response.json();
                    wardrobeGrid.innerHTML = `<p style="color: red;">Error loading wardrobe: ${errorData.error}</p>`;
                }
            } catch (error) {
                wardrobeGrid.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        // Display wardrobe items
        function displayWardrobeItems(items) {
            const wardrobeGrid = document.getElementById('wardrobeGrid');
            
            wardrobeGrid.innerHTML = items.map(item => `
                <div class="wardrobe-item">
                    <img src="${item.image_url}" alt="Clothing item" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22150%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23f0f0f0%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22>No Image</text></svg>'">
                    <p><strong>Category:</strong> ${item.type_category}</p>
                    <div class="item-tags">
                        ${item.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Clean up unknown items
        async function cleanupUnknownItems() {
            if (!confirm('This will remove all items with unknown categories or tags. Are you sure?')) {
                return;
            }

            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            loading.textContent = 'Cleaning up unknown items...';

            try {
                const response = await fetch('/cleanup-unknown', {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (response.ok) {
                    alert(`Successfully removed ${data.deleted_count} unknown items`);
                    loadWardrobe(); // Reload wardrobe
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                loading.style.display = 'none';
            }
        }

        // Initialize on page load
        checkAuth();
    </script>
</body>
</html>